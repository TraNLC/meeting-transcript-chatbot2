# Add this to api_history.py after the /chat endpoint

@history_bp.route('/chat-stream', methods=['POST'])
def chat_history_stream():
    """Stream chat with meeting history using RAG.
    
    Request:
    {
        "message": "What did we decide about the budget?",
        "session_id": "optional_session_id"
    }
    
    Response: Server-Sent Events (SSE) stream
    - data: {"chunk": "text chunk"}
    - data: {"sources": [...]}
    - data: {"error": "..."}
    - data: {"done": true}
    """
    from flask import Response, stream_with_context
    from backend.rag.conversation_manager import get_conversation_manager
    import json
    
    def generate():
        try:
            engine = get_rag_engine()
            if engine is None:
                yield f'data: {json.dumps({"error": "RAG Engine not available"})}\n\n'
                return
                
            data = request.json
            query = data.get('message', '').strip()
            
            if not query:
                yield f'data: {json.dumps({"error": "Message is required"})}\n\n'
                return
            
            # Get or create session ID
            session_id = data.get('session_id') or request.cookies.get('chat_session_id')
            if not session_id:
                import uuid
                session_id = str(uuid.uuid4())
            
            # Get conversation manager
            conv_manager = get_conversation_manager()
            
            # Get conversation history
            history = conv_manager.get_history(session_id)
            
            # Stream chat with history
            full_answer = ""
            for event_json in engine.chat_stream(query, conversation_history=history):
                yield f'data: {event_json}\n\n'
                
                # Collect answer for saving
                event = json.loads(event_json)
                if "chunk" in event:
                    full_answer += event["chunk"]
            
            # Save to conversation history
            conv_manager.add_message(session_id, "user", query)
            conv_manager.add_message(session_id, "assistant", full_answer)
            
            # Send session_id and done signal
            yield f'data: {json.dumps({"session_id": session_id, "done": True})}\n\n'
            
        except Exception as e:
            print(f"Error in streaming chat: {e}")
            import traceback
            traceback.print_exc()
            yield f'data: {json.dumps({"error": str(e)})}\n\n'
    
    return Response(
        stream_with_context(generate()),
        mimetype='text/event-stream',
        headers={
            'Cache-Control': 'no-cache',
            'X-Accel-Buffering': 'no'
        }
    )
