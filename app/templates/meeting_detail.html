{% extends "base.html" %}

{% block title %}Chi ti·∫øt cu·ªôc h·ªçp - Akari AI{% endblock %}

{% block page_styles %}
<link href="{{ url_for('static', filename='css/history.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="detail-container">
    <div id="loadingState" class="loading-state">
        <div class="loading-spinner mb-3"></div>
        <p class="text-muted">ƒêang t·∫£i...</p>
    </div>

    <div id="contentState" style="display: none;">
        <div class="detail-header">
            <div class="detail-title" id="meetingTitle">Cu·ªôc h·ªçp</div>
            <div class="detail-meta" id="meetingMeta">
                <!-- Meta will be inserted here -->
            </div>
            <div class="action-bar">
                <button class="btn-action" onclick="window.location.href='/history'">
                    <i class="bi bi-arrow-left"></i>
                    <span>Quay l·∫°i</span>
                </button>
                <button class="btn-action" onclick="exportFile('txt')">
                    <i class="bi bi-file-text"></i>
                    <span>Export TXT</span>
                </button>
                <button class="btn-action" onclick="exportFile('docx')">
                    <i class="bi bi-file-word"></i>
                    <span>Export DOCX</span>
                </button>
                <button class="btn-action" onclick="toggleChat()">
                    <i class="bi bi-chat-dots"></i>
                    <span>Chat AI</span>
                </button>
            </div>
        </div>

        <div class="content-tabs">
            <button class="content-tab active" data-tab="summary">
                <i class="bi bi-file-text me-2"></i>T√≥m t·∫Øt
            </button>
            <button class="content-tab" data-tab="transcript">
                <i class="bi bi-chat-left-text me-2"></i>Transcript
            </button>
            <button class="content-tab" data-tab="analysis">
                <i class="bi bi-graph-up me-2"></i>Ph√¢n t√≠ch
            </button>
        </div>

        <div class="content-panel active" id="summaryPanel">
            <div class="content-card">
                <h5><i class="bi bi-file-text"></i>T√≥m t·∫Øt cu·ªôc h·ªçp</h5>
                <div id="summaryContent"></div>
            </div>
            <div class="content-card">
                <h5><i class="bi bi-tag"></i>Ch·ªß ƒë·ªÅ ch√≠nh</h5>
                <div id="topicsContent"></div>
            </div>
        </div>

        <div class="content-panel" id="transcriptPanel">
            <div class="content-card">
                <h5><i class="bi bi-chat-left-text"></i>N·ªôi dung ƒë·∫ßy ƒë·ªß</h5>
                <div class="transcript-text" id="transcriptContent"></div>
            </div>
        </div>

        <div class="content-panel" id="analysisPanel">
            <div class="content-card">
                <h5><i class="bi bi-check2-square"></i>H√†nh ƒë·ªông c·∫ßn l√†m</h5>
                <div id="actionsContent"></div>
            </div>
            <div class="content-card">
                <h5><i class="bi bi-lightbulb"></i>Quy·∫øt ƒë·ªãnh quan tr·ªçng</h5>
                <div id="decisionsContent"></div>
            </div>
            <div class="content-card">
                <h5><i class="bi bi-people"></i>Ng∆∞·ªùi tham gia</h5>
                <div id="participantsContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Widget -->
<div class="chat-widget" id="chatWidget" style="display: none;">
    <div class="chat-header">
        <span>üí¨ Chat v·ªõi AI</span>
        <button onclick="toggleChat()" style="background: none; border: none; color: white; cursor: pointer;">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    <div class="chat-body" id="chatBody">
        <div class="chat-message ai">
            <div class="chat-bubble">
                Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n ph√¢n t√≠ch cu·ªôc h·ªçp n√†y. H√£y h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨!
            </div>
        </div>
    </div>
    <div class="chat-footer">
        <input type="text" class="chat-input" id="chatInput" placeholder="Nh·∫≠p c√¢u h·ªèi...">
        <button class="chat-send" id="chatSend">
            <i class="bi bi-send"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const meetingId = "{{ meeting_id }}";
    let meetingData = null;

    // Load meeting detail on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadMeetingDetail();
    });

    // Tab switching
    document.querySelectorAll('.content-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;

            document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));

            tab.classList.add('active');
            document.getElementById(tabName + 'Panel').classList.add('active');
        });
    });

    // Chat
    document.getElementById('chatSend').addEventListener('click', sendMessage);
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    async function loadMeetingDetail() {
        try {
            const response = await fetch(`/api/history/get/${encodeURIComponent(meetingId)}`);
            const data = await response.json();

            meetingData = data;
            displayMeetingDetail(data);

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentState').style.display = 'block';
        } catch (error) {
            console.error('Error loading meeting:', error);
            document.getElementById('loadingState').innerHTML = `
                <div class="text-center text-danger">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                    <p class="mt-3">L·ªói t·∫£i d·ªØ li·ªáu</p>
                </div>
            `;
        }
    }

    function displayMeetingDetail(data) {
        // API returns {found: true, analysis: {...}}
        const analysis = data.analysis || {};
        const title = analysis.original_file ?
            analysis.original_file.replace(/\.mp3$/i, '').replace(/_/g, ' ') :
            'Cu·ªôc h·ªçp';
        const timestamp = analysis.timestamp ? new Date(analysis.timestamp).toLocaleString('vi-VN') : 'N/A';
        const duration = '0:00'; // Not in API response
        const language = 'VI';

        document.getElementById('meetingTitle').textContent = title;
        document.getElementById('meetingMeta').innerHTML = `
            <div class="detail-meta-item">
                <i class="bi bi-calendar3"></i>
                <span>${timestamp}</span>
            </div>
            <div class="detail-meta-item">
                <i class="bi bi-clock"></i>
                <span>${duration}</span>
            </div>
            <div class="detail-meta-item">
                <i class="bi bi-translate"></i>
                <span>${language}</span>
            </div>
        `;

        // Summary
        document.getElementById('summaryContent').innerHTML = analysis.summary || 'Kh√¥ng c√≥ t√≥m t·∫Øt';

        // Topics - handle both string array and object array
        const topics = analysis.topics || [];
        if (topics.length > 0) {
            const topicsHtml = topics.map(t => {
                if (typeof t === 'string') {
                    return `<li>${t}</li>`;
                } else {
                    return `<li>${t.topic || t.name || ''}</li>`;
                }
            }).join('');
            document.getElementById('topicsContent').innerHTML = `<ul>${topicsHtml}</ul>`;
        } else {
            document.getElementById('topicsContent').innerHTML = 'Kh√¥ng c√≥ ch·ªß ƒë·ªÅ';
        }

        // Transcript
        document.getElementById('transcriptContent').textContent = analysis.transcript || 'Kh√¥ng c√≥ transcript';

        // Actions - handle both string array and object array
        const actions = analysis.actions || [];
        if (actions.length > 0) {
            const actionsHtml = actions.map(a => {
                if (typeof a === 'string') {
                    return `<li>${a}</li>`;
                } else {
                    return `<li><strong>${a.assignee || 'N/A'}:</strong> ${a.task || a.action || ''}</li>`;
                }
            }).join('');
            document.getElementById('actionsContent').innerHTML = `<ul>${actionsHtml}</ul>`;
        } else {
            document.getElementById('actionsContent').innerHTML = 'Kh√¥ng c√≥ h√†nh ƒë·ªông';
        }

        // Decisions - handle both string array and object array
        const decisions = analysis.decisions || [];
        if (decisions.length > 0) {
            const decisionsHtml = decisions.map(d => {
                if (typeof d === 'string') {
                    return `<li>${d}</li>`;
                } else {
                    return `<li>${d.decision || d.text || ''}</li>`;
                }
            }).join('');
            document.getElementById('decisionsContent').innerHTML = `<ul>${decisionsHtml}</ul>`;
        } else {
            document.getElementById('decisionsContent').innerHTML = 'Kh√¥ng c√≥ quy·∫øt ƒë·ªãnh';
        }

        document.getElementById('participantsContent').innerHTML = 'Kh√¥ng c√≥ th√¥ng tin';
    }

    function toggleChat() {
        const widget = document.getElementById('chatWidget');
        widget.style.display = widget.style.display === 'none' ? 'flex' : 'none';
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message) return;

        addChatMessage(message, 'user');
        input.value = '';

        try {
            const response = await fetch('/api/chat/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();
            if (data.answer) {
                addChatMessage(data.answer, 'ai');
            } else {
                addChatMessage('Xin l·ªói, t√¥i kh√¥ng th·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi n√†y.', 'ai');
            }
        } catch (error) {
            console.error('Chat error:', error);
            addChatMessage('Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra.', 'ai');
        }
    }

    function addChatMessage(text, sender) {
        const chatBody = document.getElementById('chatBody');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${sender}`;
        messageDiv.innerHTML = `<div class="chat-bubble">${text}</div>`;
        chatBody.appendChild(messageDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function exportFile(type) {
        window.open(`/api/export/${type}`, '_blank');
    }
</script>
{% endblock %}