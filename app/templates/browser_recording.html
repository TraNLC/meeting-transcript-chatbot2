{% extends "base.html" %}

{% block title %}Ghi √¢m Browser - Akari AI{% endblock %}

{% block page_styles %}
<link href="{{ url_for('static', filename='css/recording.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="recording-container">
    <div class="recording-card">
        <!-- SETUP SECTION -->
        <div id="setupSection" class="setup-section">
            <div class="recording-header">
                <div class="recording-icon">
                    <i class="bi bi-laptop"></i>
                </div>
                <h2>Browser Recording</h2>
                <p>Ghi √¢m cu·ªôc h·ªçp t·ª´ Zoom, Meet, Teams</p>
            </div>

            <div class="form-group">
                <label for="languageSelect" class="form-label">Ch·ªçn ng√¥n ng·ªØ</label>
                <select id="languageSelect" class="form-select" aria-label="Ch·ªçn ng√¥n ng·ªØ">
                    <option value="vi-VN">üáªüá≥ Ti·∫øng Vi·ªát</option>
                    <option value="en-US">üá¨üáß English (US)</option>
                    <option value="ja-JP">üáØüáµ Êó•Êú¨Ë™û</option>
                    <option value="ko-KR">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                    <option value="zh-CN">üá®üá≥ ‰∏≠Êñá</option>
                </select>
            </div>

            <div class="form-group">
                <label for="titleInput" class="form-label">Ti√™u ƒë·ªÅ cu·ªôc h·ªçp</label>
                <input type="text" id="titleInput" class="form-control" placeholder="VD: Daily Meeting..."
                       aria-label="Ti√™u ƒë·ªÅ cu·ªôc h·ªçp">
            </div>

            <!-- Zero Cost Info -->
            <div class="info-box">
                <i class="bi bi-rocket-takeoff-fill"></i>
                <div class="info-content">
                    <strong>Zero Cost Mode (Disabled Live Transcript)</strong>
                    <p>H·ªá th·ªëng ch·ªâ ghi √¢m v√† x·ª≠ l√Ω sau khi k·∫øt th√∫c ƒë·ªÉ t·ªëi ∆∞u hi·ªáu nƒÉng.</p>
                    <ul>
                        <li>B∆∞·ªõc 1: B·∫•m "B·∫Øt ƒë·∫ßu" ƒë·ªÉ ghi √¢m Browser Tab.</li>
                        <li>B∆∞·ªõc 2: K·∫øt th√∫c h·ªçp -> H·ªá th·ªëng t·ª± x·ª≠ l√Ω qua Colab/Local.</li>
                    </ul>
                </div>
            </div>

            <!-- Colab URL Input (Auto-Connect Support) -->
            <div class="form-group">
                <label for="colabUrlInput" class="form-label">Colab WhisperX URL (Optional)</label>
                <input type="text" id="colabUrlInput" class="form-control" placeholder="https://xxxx.ngrok-free.app"
                       aria-label="Colab WhisperX URL (Optional)">
                <small class="text-muted d-block mt-1">
                    <a href="#" onclick="showColabGuide(); return false;">H∆∞·ªõng d·∫´n setup & Auto-Connect</a>
                </small>
            </div>

            <div class="text-center mt-4">
                <button id="startBtn" class="btn-primary-gradient">
                    <i class="bi bi-record-circle"></i> B·∫Øt ƒë·∫ßu ghi √¢m
                </button>
            </div>
        </div>

        <!-- RECORDING VIEW (Hidden) -->
        <div id="recordingSection" class="recording-view" style="display: none;">
            <div class="recording-badge">
                <span class="pulse-dot"></span>
                LIVE RECORDING
            </div>

            <div id="timer" class="recording-timer">00:00</div>

            <p id="recordingTitleDisplay" class="text-muted mb-4" style="font-size: 1.1rem;"></p>

            <div class="visualizer-container">
                <!-- Simple animation bars -->
                <div class="vis-bar"></div>
                <div class="vis-bar"></div>
                <div class="vis-bar"></div>
                <div class="vis-bar"></div>
                <div class="vis-bar"></div>
            </div>

            <div class="mt-5">
                <button id="stopBtn" class="btn-danger">
                    <i class="bi bi-stop-circle"></i> K·∫øt th√∫c & X·ª≠ l√Ω
                </button>
            </div>
        </div>
        <!-- RESULT SECTION (Hidden) -->
        <div id="resultSection" style="display: none;">
            <div id="resultContent"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // ============================================
    // SIMPLIFIED BROWSER RECORDING (No Live Transcript)
    // ============================================

    // ============================================
    // MANUAL BROWSER RECORDING FLOW
    // ============================================

    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = null;
    let timerInterval = null;
    let recordedBlob = null;
    let visInterval = null;

    document.getElementById('startBtn').addEventListener('click', async () => {
        console.log('Starting Browser Recording...');
        const title = document.getElementById('titleInput').value || `Meeting ${new Date().toLocaleString('vi-VN')}`;
        const language = document.getElementById('languageSelect').value;
        const colabUrl = document.getElementById('colabUrlInput').value.trim();

        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({
                video: true,
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                }
            });

            // Safely attach onended if there's a video track (display capture may include video)
            const videoTracks = stream.getVideoTracks();
            if (videoTracks && videoTracks.length > 0) {
                videoTracks[0].onended = () => stopRecording();
            }

            // Choose a mimeType that matches the captured tracks (video vs audio) and is supported
            const hasVideo = stream.getVideoTracks().length > 0;
            const candidates = hasVideo
                    ? ['video/webm;codecs=vp8,opus', 'video/webm;codecs=vp9,opus', 'video/webm']
                    : ['audio/webm;codecs=opus', 'audio/webm'];

            let mimeType = '';
            for (const c of candidates) {
                try {
                    if (MediaRecorder.isTypeSupported(c)) {
                        mimeType = c;
                        break;
                    }
                } catch (e) {
                    // Some browsers may throw when checking unsupported strings; ignore and continue
                    console.warn('isTypeSupported threw for', c, e);
                }
            }

            // Construct MediaRecorder with a safe fallback and robust error handling
            try {
                mediaRecorder = mimeType ? new MediaRecorder(stream, {mimeType}) : new MediaRecorder(stream);
            } catch (ctorErr) {
                console.warn('MediaRecorder constructor failed with mimeType:', mimeType, ctorErr);
                try {
                    mediaRecorder = new MediaRecorder(stream);
                } catch (ctorErr2) {
                    console.error('MediaRecorder not available for this stream:', ctorErr2);
                    showPopup('L·ªói: Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ghi √¢m cho lu·ªìng n√†y.', 'error');
                    return;
                }
            }

            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data && event.data.size > 0) audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => handleRecordingStopped(title, language, colabUrl);

            try {
                // Start with 1s timeslice if supported; some browsers may ignore the timeslice parameter
                mediaRecorder.start(1000);
            } catch (startErr) {
                console.error('Failed to start MediaRecorder:', startErr);
                showPopup('L·ªói: Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu ghi √¢m tr√™n tr√¨nh duy·ªát n√†y.', 'error');
                // Clean up tracks
                try {
                    stream.getTracks().forEach(t => t.stop());
                } catch (e) {
                }
                return;
            }

            // UI Switch
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('recordingSection').style.display = 'block';
            document.getElementById('recordingTitleDisplay').textContent = title;

            // Start Timer
            recordingStartTime = Date.now();
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
            startFakeVisualizer();

        } catch (error) {
            console.error(error);
            showPopup('L·ªói: ' + error.message, 'error');
        }
    });

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
        if (timerInterval) clearInterval(timerInterval);

        if (mediaRecorder && mediaRecorder.stream) {
            mediaRecorder.stream.getTracks().forEach(t => t.stop());
        }
    }

    document.getElementById('stopBtn').addEventListener('click', stopRecording);

    function updateTimer() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const secs = String(elapsed % 60).padStart(2, '0');
        document.getElementById('timer').textContent = `${mins}:${secs}`;
    }

    function startFakeVisualizer() {
        const bars = document.querySelectorAll('.vis-bar');
        visInterval = setInterval(() => {
            bars.forEach(bar => {
                bar.style.height = Math.floor(Math.random() * 40 + 10) + 'px';
            });
        }, 100);
    }

    // 1. HANDLE STOP -> SHOW REVIEW UI
    function handleRecordingStopped(title, language, colabUrl) {
        clearInterval(visInterval);
        recordedBlob = new Blob(audioChunks, {type: 'audio/webm'});

        // Hide Recording, Show Result Container
        document.getElementById('recordingSection').style.display = 'none';
        document.getElementById('resultSection').style.display = 'block';

        const container = document.getElementById('resultContent');
        container.innerHTML = `
            <div class="text-center py-5">
                <div class="mb-4">
                    <div style="width: 80px; height: 80px; background: #d1fae5; color: #059669; font-size: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                        <i class="bi bi-check-lg"></i>
                    </div>
                    <h3 class="mt-3 fw-bold">Ghi √¢m ho√†n t·∫•t!</h3>
                    <p class="text-muted">Nghe l·∫°i v√† b·∫•m Ph√¢n t√≠ch ƒë·ªÉ ti·∫øp t·ª•c.</p>
                </div>

                <div class="card p-3 mb-4 border-0 shadow-sm bg-light">
                     <audio controls src="${URL.createObjectURL(recordedBlob)}" style="width: 100%;"></audio>
                </div>

                <div class="d-flex justify-content-center gap-3">
                    <button id="analyzeBtn" class="btn btn-primary-gradient px-5 py-2">
                        <i class="bi bi-stars me-2"></i>Ph√¢n t√≠ch ngay
                    </button>
                    <button onclick="location.reload()" class="btn btn-outline-secondary px-4 py-2">
                        H·ªßy b·ªè
                    </button>
                </div>
            </div>
        `;

        document.getElementById('analyzeBtn').addEventListener('click', () => startAnalysis(title, language, colabUrl));
    }

    // 2. START ANALYSIS -> HIT BACKEND
    async function startAnalysis(title, language, colabUrl) {
        showLoading('ƒêang ph√¢n t√≠ch...', 'Vui l√≤ng ƒë·ª£i AI x·ª≠ l√Ω...');

        try {
            const formData = new FormData();
            formData.append('audio_file', recordedBlob, 'browser_recording.webm');
            formData.append('transcribe_lang', language);
            formData.append('output_lang', language);
            formData.append('meeting_type', 'meeting');
            formData.append('file_type', 'audio');
            // We could pass colabUrl as extra param if API supports it,
            // but respecting "Logic at Server", we send standard request.

            // If user supplied a Colab/auto-connect URL, forward it to the server (optional)
            if (colabUrl) {
                formData.append('colab_url', colabUrl);
            }

            const res = await fetch('/api/upload/process', {
                method: 'POST',
                body: formData
            });

            if (!res.ok) {
                // include server response text in error when available for better debugging
                const txt = await res.text().catch(() => '');
                const msg = 'Analysis Request Failed: ' + (txt || res.status);
                hideLoading();
                showPopup(msg, 'error');
                return;
            }

            const data = await res.json();

            // Redirect to dedicated browser recording analysis page
            hideLoading();

            // Save data to sessionStorage
            sessionStorage.setItem('analysisData', JSON.stringify({
                success: true,
                transcript: data.transcript || '',
                summary: data.summary || '',
                topics: data.topics || [],
                actions: data.actions || [],
                decisions: data.decisions || [],
                participants: data.participants || []
            }));

            sessionStorage.setItem('fileInfo', JSON.stringify({
                name: 'browser_recording.webm',
                size: 'N/A',
                type: 'Browser Recording'
            }));

            // Redirect to browser recording analysis page
            window.location.href = '/recordbrowseranalysis';

        } catch (e) {
            hideLoading();
            showPopup('L·ªói ph√¢n t√≠ch: ' + e.message, 'error');
        }
    }

    // 3. RENDER RESULT (Matched Upload UI)
    function renderResult(data) {
        const container = document.getElementById('resultContent');

        if (data.status && data.status.startsWith('‚úÖ')) {
            const summary = data.info?.summary || data.summary || 'Kh√¥ng c√≥ t√≥m t·∫Øt';

            container.innerHTML = `
                <div class="text-center mb-4">
                    <div style="width: 60px; height: 60px; background: var(--primary-gradient); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                         <i class="bi bi-file-text text-white fs-3"></i>
                    </div>
                    <h3 class="fw-bold">${data.info?.title || 'K·∫øt qu·∫£ ph√¢n t√≠ch'}</h3>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold text-primary"><i class="bi bi-stars me-2"></i>T√≥m t·∫Øt n·ªôi dung</h5>
                    </div>
                    <div class="card-body bg-light">
                        <div style="white-space: pre-wrap; line-height: 1.6;">${summary}</div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <a href="/history" class="btn btn-primary-gradient px-4">Xem chi ti·∫øt</a>
                    <button onclick="location.reload()" class="btn btn-outline-secondary px-4 ms-2">L√†m m·ªõi</button>
                </div>
             `;
        } else {
            container.innerHTML = `
                <div class="alert alert-danger text-center">
                    <h5>‚ùå L·ªói x·ª≠ l√Ω</h5>
                    <p>${data.message || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                    <button onclick="location.reload()" class="btn btn-secondary mt-2">Th·ª≠ l·∫°i</button>
                </div>
             `;
        }
    }


    // Auto-Connect Helper (Simplified Copy)
    function showColabGuide() {
        // Just open the link for now or Show Popup
        alert("Vui l√≤ng m·ªü Notebook tr√™n Colab -> Run All -> Copy URL v√†o ƒë√¢y.");
    }
</script>
{% endblock %}