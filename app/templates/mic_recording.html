{% extends "base.html" %}

{% block title %}Ghi √¢m Microphone - Akari AI{% endblock %}

{% block page_styles %}
<link href="{{ url_for('static', filename='css/recording.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="recording-container mic-page">
    <div class="recording-card">
        <!-- SETUP SECTION -->
        <div id="setupSection" class="setup-section">
            <div class="recording-header">
                <div class="recording-icon">
                    <i class="bi bi-mic-fill"></i>
                </div>
                <h2>Ghi √¢m Microphone</h2>
                <p>Thu √¢m tr·ª±c ti·∫øp cu·ªôc h·ªçp ho·∫∑c ph·ªèng v·∫•n</p>
            </div>

            <div class="form-group">
                <label class="form-label">Ch·ªçn ng√¥n ng·ªØ</label>
                <select id="languageSelect" class="form-select">
                    <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                    <option value="en">üá¨üáß English</option>
                    <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                    <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                    <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Ti√™u ƒë·ªÅ cu·ªôc h·ªçp</label>
                <input type="text" id="titleInput" class="form-control" placeholder="VD: Ph·ªèng v·∫•n ·ª©ng vi√™n...">
            </div>

            <!-- Info Box -->
            <div class="alert alert-info mt-3" style="background: #fff0f7; border-color: #fbcfe8; color: #be185d;">
                <i class="bi bi-stars me-2"></i>
                <strong>Zero Cost Mode:</strong> Ch·∫ø ƒë·ªô ghi √¢m local ch·∫•t l∆∞·ª£ng cao (Opus). X·ª≠ l√Ω AI sau khi k·∫øt th√∫c.
            </div>

            <div class="text-center mt-4">
                <button id="startBtn" class="btn-primary-gradient">
                    <i class="bi bi-record-circle"></i> B·∫Øt ƒë·∫ßu ghi √¢m
                </button>
            </div>
        </div>

        <!-- RECORDING VIEW (Hidden) -->
        <div id="recordingSection" class="recording-view" style="display: none;">
            <div class="recording-badge" style="background: #fdf2f8; color: #db2777;">
                <span class="pulse-dot" style="color: #db2777;"></span>
                MIC RECORDING
            </div>

            <div id="timer" class="recording-timer">00:00</div>

            <p id="recordingTitleDisplay" class="text-muted mb-4" style="font-size: 1.1rem;"></p>

            <div class="visualizer-container" id="visualizerBars">
                <!-- Bars generated via JS -->
            </div>

            <div class="mt-5">
                <button id="stopBtn" class="btn-danger">
                    <i class="bi bi-stop-circle"></i> K·∫øt th√∫c & X·ª≠ l√Ω
                </button>
            </div>
        </div>
        <!-- RESULT SECTION (Hidden) -->
        <div id="resultSection" style="display: none;">
            <div id="resultContent"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // ============================================
    // SIMPLIFIED MIC RECORDING
    // ============================================

    // ============================================
    // MANUAL MIC RECORDING FLOW
    // ============================================

    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = null;
    let timerInterval = null;
    let audioContext = null;
    let analyser = null;
    let visualizerInterval = null;
    let recordedBlob = null;

    document.getElementById('startBtn').addEventListener('click', async () => {
        const title = document.getElementById('titleInput').value || `Mic Recording - ${new Date().toLocaleString('vi-VN')}`;
        const language = document.getElementById('languageSelect').value;

        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                }
            });

            // Audio Visualizer Setup
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 64;

            const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
                ? 'audio/webm;codecs=opus'
                : 'audio/webm';

            mediaRecorder = new MediaRecorder(stream, { mimeType });
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => handleRecordingStopped(title, language);

            mediaRecorder.start(1000);

            // UI Switch
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('recordingSection').style.display = 'block';
            document.getElementById('recordingTitleDisplay').textContent = title;

            // Start Visualizer
            initVisualizer();
            visualizerInterval = setInterval(animateVisualizer, 100);

            // Start Timer
            recordingStartTime = Date.now();
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);

        } catch (error) {
            console.error(error);
            showPopup('L·ªói: Kh√¥ng th·ªÉ truy c·∫≠p Microphone', 'error');
        }
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
        if (timerInterval) clearInterval(timerInterval);
        if (visualizerInterval) clearInterval(visualizerInterval);

        if (audioContext) audioContext.close();

        if (mediaRecorder && mediaRecorder.stream) {
            mediaRecorder.stream.getTracks().forEach(t => t.stop());
        }
    });

    // 1. HANDLE STOP -> REVIEW UI
    function handleRecordingStopped(title, language) {
        recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });

        // UI Transition -> Result/Review
        document.getElementById('recordingSection').style.display = 'none';
        document.getElementById('resultSection').style.display = 'block';

        const container = document.getElementById('resultContent');
        container.innerHTML = `
            <div class="text-center py-5">
                <div class="mb-4">
                    <div style="width: 80px; height: 80px; background: #fce7f3; color: #db2777; font-size: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                        <i class="bi bi-mic-fill"></i>
                    </div>
                    <h3 class="mt-3 fw-bold">ƒê√£ ghi √¢m xong!</h3>
                    <p class="text-muted">Nghe l·∫°i v√† b·∫•m Ph√¢n t√≠ch ƒë·ªÉ ti·∫øp t·ª•c.</p>
                </div>

                <div class="card p-3 mb-4 border-0 shadow-sm bg-light">
                     <audio controls src="${URL.createObjectURL(recordedBlob)}" style="width: 100%;"></audio>
                </div>
                
                <div class="d-flex justify-content-center gap-3">
                    <button id="analyzeBtn" class="btn btn-primary-gradient px-5 py-2">
                        <i class="bi bi-stars me-2"></i>Ph√¢n t√≠ch ngay
                    </button>
                    <button onclick="location.reload()" class="btn btn-outline-secondary px-4 py-2">
                        H·ªßy
                    </button>
                </div>
            </div>
        `;

        document.getElementById('analyzeBtn').addEventListener('click', () => startAnalysis(title, language));
    }

    // 2. START ANALYSIS -> BACKEND
    async function startAnalysis(title, language) {
        showLoading('ƒêang ph√¢n t√≠ch...', 'Vui l√≤ng ƒë·ª£i...');

        try {
            const formData = new FormData();
            formData.append('audio_file', recordedBlob, 'mic_recording.webm');
            formData.append('transcribe_lang', language);
            formData.append('output_lang', language);
            formData.append('meeting_type', 'meeting');
            formData.append('file_type', 'audio');

            const res = await fetch('/api/upload/process', {
                method: 'POST',
                body: formData
            });

            if (!res.ok) throw new Error('Request Failed');

            const data = await res.json();
            renderResult(data);
            hideLoading();

        } catch (e) {
            hideLoading();
            showPopup('L·ªói: ' + e.message, 'error');
        }
    }

    // 3. RENDER RESULT
    function renderResult(data) {
        const container = document.getElementById('resultContent');

        if (data.status && data.status.startsWith('‚úÖ')) {
            const summary = data.info?.summary || data.summary || 'Kh√¥ng c√≥ t√≥m t·∫Øt';

            container.innerHTML = `
                <div class="text-center mb-4">
                    <div style="width: 60px; height: 60px; background: var(--secondary-gradient); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                         <i class="bi bi-check-lg text-white fs-3"></i>
                    </div>
                    <h3 class="fw-bold">${data.info?.title || 'Ph√¢n t√≠ch Ho√†n t·∫•t'}</h3>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold text-danger"><i class="bi bi-stars me-2"></i>K·∫øt qu·∫£ AI</h5>
                    </div>
                    <div class="card-body bg-light">
                        <div style="white-space: pre-wrap; line-height: 1.6;">${summary}</div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <a href="/history" class="btn btn-primary-gradient px-4">Xem chi ti·∫øt</a>
                    <button onclick="location.reload()" class="btn btn-outline-secondary px-4 ms-2">Ghi √¢m m·ªõi</button>
                </div>
             `;
        } else {
            container.innerHTML = `
                <div class="alert alert-danger text-center">
                    <h5>‚ùå L·ªói x·ª≠ l√Ω</h5>
                    <p>${data.message || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                    <button onclick="location.reload()" class="btn btn-secondary mt-2">Th·ª≠ l·∫°i</button>
                </div>
             `;
        }
    }

    function updateTimer() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const secs = String(elapsed % 60).padStart(2, '0');
        document.getElementById('timer').textContent = `${mins}:${secs}`;
    }

    // Simple Visualizer Logic
    function initVisualizer() {
        const container = document.getElementById('visualizerBars');
        container.innerHTML = '';
        for (let i = 0; i < 15; i++) {
            const bar = document.createElement('div');
            bar.className = 'vis-bar';
            container.appendChild(bar);
        }
    }

    function animateVisualizer() {
        if (!analyser) return;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);

        const bars = document.querySelectorAll('.vis-bar');
        bars.forEach((bar, index) => {
            const val = dataArray[index] || 0;
            const height = Math.max(10, (val / 255) * 50);
            bar.style.height = height + 'px';
            if (val > 100) {
                bar.classList.add('active');
            } else {
                bar.classList.remove('active');
            }
        });
    }
</script>
{% endblock %}