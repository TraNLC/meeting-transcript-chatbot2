{% extends "base.html" %}

{% block title %}L·ªãch s·ª≠ - Akari AI{% endblock %}

{% block page_styles %}
<link href="{{ url_for('static', filename='css/history.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="history-container">
    <div class="history-header">
        <div class="history-icon">
            <i class="bi bi-clock-history"></i>
        </div>
        <h2>L·ªãch s·ª≠ cu·ªôc h·ªçp</h2>
        <p class="text-muted mb-0">Xem l·∫°i c√°c cu·ªôc h·ªçp v√† ph√¢n t√≠ch ƒë√£ th·ª±c hi·ªán</p>
    </div>

    <!-- Search Section -->
    <div class="search-section" style="margin-bottom: 2rem;">
        <div class="search-bar"
            style="display: flex; gap: 0.5rem; align-items: center; background: white; padding: 0.75rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <i class="bi bi-search" style="color: #6366f1; font-size: 1.25rem;"></i>
            <input id="searchInput" type="text" placeholder="T√¨m cu·ªôc h·ªçp (VD: 'workshop', 'interview')"
                style="flex: 1; border: none; outline: none; font-size: 1rem; padding: 0.25rem;" />
            <button id="searchBtn" class="btn btn-primary" onclick="performSemanticSearch()"
                style="padding: 0.5rem 1.5rem; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; border-radius: 8px; color: white; font-weight: 500;">
                T√¨m ki·∫øm
            </button>
            <button id="clearSearchBtn" class="btn btn-outline-secondary" onclick="clearSearch()"
                style="display: none;">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div id="searchStatus" style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;"></div>
    </div>

    <!-- Additional Styles for Chat -->
    <style>
        .chat-message {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .chat-message.user-message {
            flex-direction: row-reverse;
        }

        .chat-message .message-content {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .ai-message .message-content {
            background: white;
            border: 1px solid #e5e7eb;
            border-top-left-radius: 0;
            color: #1f2937;
        }

        .user-message .message-content {
            background: #6366f1;
            color: white;
            border-top-right-radius: 0;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e0e7ff;
            color: #6366f1;
            flex-shrink: 0;
        }

        .user-message .message-avatar {
            background: #fee2e2;
            color: #ef4444;
        }

        .source-citation {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #eee;
            color: #6b7280;
        }

        .source-link {
            color: #6366f1;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        .source-link:hover {
            text-decoration: underline;
        }
    </style>

    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-group">
                <label class="filter-label">Lo·∫°i cu·ªôc h·ªçp</label>
                <select id="filterType" class="filter-select">
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="meeting">Cu·ªôc h·ªçp</option>
                    <option value="interview">Ph·ªèng v·∫•n</option>
                    <option value="presentation">Thuy·∫øt tr√¨nh</option>
                    <option value="brainstorm">Brainstorming</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">S·∫Øp x·∫øp</label>
                <select id="filterSort" class="filter-select">
                    <option value="newest">M·ªõi nh·∫•t</option>
                    <option value="oldest">C≈© nh·∫•t</option>
                    <option value="name">T√™n A-Z</option>
                    <option value="relevance" id="relevanceOption" style="display: none;">Li√™n quan nh·∫•t</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">&nbsp;</label>
                <button class="btn btn-outline-secondary w-100" onclick="loadHistory()">
                    <i class="bi bi-arrow-clockwise me-2"></i>L√†m m·ªõi
                </button>
            </div>
        </div>
    </div>

    <div id="meetingsContainer">
        <div class="loading-state">
            <div class="loading-spinner mb-3"></div>
            <p class="text-muted">ƒêang t·∫£i...</p>
        </div>
    </div>

    <!-- Pagination -->
    <div id="paginationContainer" style="display: none; margin-top: 2rem;">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" id="paginationList">
                <!-- Will be populated by JavaScript -->
            </ul>
        </nav>
        <p class="text-center text-muted" id="paginationInfo" style="font-size: 0.9rem; margin-top: 1rem;"></p>
    </div>
</div>

<!-- Floating Chatbox -->
<div id="floatingChatbox" class="floating-chatbox minimized">
    <!-- Minimized State -->
    <div class="chatbox-minimized" onclick="toggleChatbox()">
        <i class="bi bi-chat-dots-fill"></i>
        <span class="chat-badge" id="chatBadge" style="display: none;">1</span>
    </div>

    <!-- Expanded State -->
    <div class="chatbox-expanded">
        <div class="chatbox-header">
            <div class="chatbox-title">
                <i class="bi bi-stars me-2"></i>
                <span>Chat v·ªõi AI</span>
            </div>
            <div class="chatbox-actions">
                <button onclick="clearChatHistory()" title="X√≥a l·ªãch s·ª≠">
                    <i class="bi bi-trash"></i>
                </button>
                <button onclick="toggleChatbox()" title="Thu nh·ªè">
                    <i class="bi bi-dash-lg"></i>
                </button>
            </div>
        </div>

        <div class="chatbox-messages" id="chatboxMessages">
            <div class="chat-message ai-message">
                <div class="message-avatar"><i class="bi bi-stars"></i></div>
                <div class="message-content">
                    Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m hi·ªÉu v·ªÅ c√°c cu·ªôc h·ªçp. H√£y th·ª≠:
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>"T√¨m workshop v·ªÅ design"</li>
                        <li>"Ai ƒë∆∞·ª£c ph·ªèng v·∫•n tu·∫ßn n√†y?"</li>
                        <li>"Quy·∫øt ƒë·ªãnh quan tr·ªçng l√† g√¨?"</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="chatbox-input">
            <input type="text" id="chatboxInput" placeholder="H·ªèi g√¨ ƒë√≥..." onkeypress="handleChatboxEnter(event)">
            <button onclick="sendChatboxMessage()">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // NO DATA STORAGE IN FRONTEND - all from backend!
    let currentMode = 'search';

    // Load history on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadHistory();
    });

    // Toggle Modes
    function switchMode(mode) {
        currentMode = mode;
        if (mode === 'search') {
            document.getElementById('searchModeContainer').style.display = 'block';
            document.getElementById('chatModeContainer').style.display = 'none';
            document.getElementById('modeSearchBtn').classList.add('active-mode');
            document.getElementById('modeSearchBtn').classList.remove('btn-outline-primary');
            document.getElementById('modeSearchBtn').classList.add('btn-primary');

            document.getElementById('modeChatBtn').classList.remove('active-mode');
            document.getElementById('modeChatBtn').classList.add('btn-outline-primary');
            document.getElementById('modeChatBtn').classList.remove('btn-primary');
        } else {
            document.getElementById('searchModeContainer').style.display = 'none';
            document.getElementById('chatModeContainer').style.display = 'block';
            document.getElementById('modeChatBtn').classList.add('active-mode');
            document.getElementById('modeChatBtn').classList.remove('btn-outline-primary');
            document.getElementById('modeChatBtn').classList.add('btn-primary');

            document.getElementById('modeSearchBtn').classList.remove('active-mode');
            document.getElementById('modeSearchBtn').classList.add('btn-outline-primary');
            document.getElementById('modeSearchBtn').classList.remove('btn-primary');
        }
    }

    // --- CHAT LOGIC ---

    function handleChatEnter(e) {
        if (e.key === 'Enter') sendChatMessage();
    }

    async function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        // 1. Add User Message
        appendMessage('user', message);
        input.value = '';
        input.disabled = true;

        // 2. Add Loading Message
        appendMessage('ai', '<div class="loading-spinner" style="width: 20px; height: 20px;"></div> ƒêang suy nghƒ©...');

        try {
            // 3. Call RAG API
            const response = await fetch('/api/history/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();

            // 4. Update with Real Answer
            const messagesDiv = document.getElementById('chatMessages');
            const loadingMsg = messagesDiv.lastElementChild;
            loadingMsg.remove(); // Remove loading

            if (data.error) {
                appendMessage('ai', `‚ö†Ô∏è L·ªói: ${data.error}`);
            } else {
                let answerHtml = data.answer.replace(/\n/g, '<br>');

                // Add sources
                if (data.sources && data.sources.length > 0) {
                    answerHtml += `<div class="source-citation"><strong>Ngu·ªìn tham kh·∫£o:</strong><br>`;
                    data.sources.forEach(src => {
                        answerHtml += `<span class="source-link" onclick="window.location.href='/history'">[${src.id}] ${src.name}</span> (ƒë·ªô tin c·∫≠y ${(src.score * 100).toFixed(0)}%)<br>`;
                    });
                    answerHtml += `</div>`;
                }

                appendMessage('ai', answerHtml);
            }

        } catch (error) {
            console.error(error);
            appendMessage('ai', '‚ö†Ô∏è Xin l·ªói, c√≥ l·ªói x·∫£y ra khi k·∫øt n·ªëi v·ªõi server.');
        } finally {
            input.disabled = false;
            input.focus();
        }
    }

    function appendMessage(role, htmlContent) {
        const messagesDiv = document.getElementById('chatMessages');
        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message ${role}-message`;

        const avatar = role === 'user' ? '<i class="bi bi-person"></i>' : '<i class="bi bi-robot"></i>';

        msgDiv.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">${htmlContent}</div>
        `;

        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return msgDiv.id;
    }

    // Filter change listeners
    document.getElementById('filterType').addEventListener('change', filterMeetings);
    document.getElementById('filterSort').addEventListener('change', filterMeetings);

    // Search input - trigger search on Enter key
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            performSemanticSearch();
        }
    });

    // Semantic Search Function (AI-powered!)
    async function performSemanticSearch() {
        const query = document.getElementById('searchInput').value.trim();

        if (!query) {
            alert('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm');
            return;
        }

        const container = document.getElementById('meetingsContainer');
        const searchStatus = document.getElementById('searchStatus');

        // Show loading
        container.innerHTML = '<div class="loading-state"><div class="loading-spinner mb-3"></div><p class="text-muted">ƒêang t√¨m ki·∫øm v·ªõi AI...</p></div>';
        searchStatus.innerHTML = '<i class="bi bi-stars"></i> ƒêang ph√¢n t√≠ch c√¢u h·ªèi c·ªßa b·∫°n...';

        try {
            // Get filter type for metadata filtering
            const filterType = document.getElementById('filterType').value;
            const filters = filterType !== 'all' ? { meeting_type: filterType } : null;

            // Call backend semantic search API
            // ALL LOGIC IS IN BACKEND - FRONTEND ONLY DISPLAYS!
            const response = await fetch('/api/history/semantic-search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: query,
                    top_k: 20,
                    filters: filters
                })
            });

            if (!response.ok) {
                throw new Error(`Server returned ${response.status}`);
            }

            const data = await response.json();

            // Update UI state
            isSearchMode = true;
            document.getElementById('clearSearchBtn').style.display = 'block';
            document.getElementById('relevanceOption').style.display = 'block';
            document.getElementById('filterSort').value = 'relevance';

            if (data.results && data.results.length > 0) {
                searchStatus.innerHTML = `<i class="bi bi-check-circle text-success"></i> T√¨m th·∫•y ${data.results.length} cu·ªôc h·ªçp li√™n quan`;
                renderSearchResults(data.results);
            } else {
                searchStatus.innerHTML = '<i class="bi bi-info-circle text-warning"></i> Kh√¥ng t√¨m th·∫•y cu·ªôc h·ªçp ph√π h·ª£p';
                showEmptyState('Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£', 'Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c');
            }

        } catch (error) {
            console.error('Search error:', error);
            searchStatus.innerHTML = '<i class="bi bi-exclamation-triangle text-danger"></i> L·ªói khi t√¨m ki·∫øm';
            container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="bi bi-exclamation-triangle"></i></div><h4>L·ªói t√¨m ki·∫øm</h4><p class="text-muted">Vui l√≤ng th·ª≠ l·∫°i</p></div>';
        }
    }

    // Clear search and return to normal view
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchStatus').innerHTML = '';
        document.getElementById('clearSearchBtn').style.display = 'none';
        document.getElementById('relevanceOption').style.display = 'none';
        document.getElementById('filterSort').value = 'newest';
        isSearchMode = false;

        // Reload normal history
        loadHistory();
    }

    // Render search results with relevance scores
    function renderSearchResults(results) {
        const container = document.getElementById('meetingsContainer');

        const html = `
            <div class="meetings-grid">
                ${results.map(result => createSearchResultCard(result)).join('')}
            </div>
        `;

        container.innerHTML = html;

        // Add click listeners
        document.querySelectorAll('.meeting-card').forEach(card => {
            card.addEventListener('click', () => {
                const meetingId = card.dataset.meetingId;
                window.location.href = `/meeting/${encodeURIComponent(meetingId)}`;
            });
        });
    }

    // Create card for search result (with relevance score)
    function createSearchResultCard(result) {
        const date = result.timestamp ? new Date(result.timestamp).toLocaleString('vi-VN') : 'N/A';
        const score = (result.score * 100).toFixed(0); // Convert to percentage
        const scoreColor = score > 70 ? '#10b981' : score > 50 ? '#f59e0b' : '#6b7280';

        return `
            <div class="meeting-card" data-meeting-id="${result.id}">
                <div class="meeting-icon-wrapper">
                    <div class="meeting-icon">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                </div>
                <div class="meeting-content">
                    <div class="meeting-title">${result.title}</div>
                    <div class="meeting-summary" style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                        ${result.summary}
                    </div>
                    <div class="meeting-meta">
                        <div class="meeting-meta-item">
                            <i class="bi bi-calendar3"></i>
                            <span>${date}</span>
                        </div>
                        <div class="meeting-meta-item" style="color: ${scoreColor}; font-weight: 600;">
                            <i class="bi bi-stars"></i>
                            <span>Ph√π h·ª£p ${score}%</span>
                        </div>
                    </div>
                </div>
                <div class="meeting-arrow">
                    <i class="bi bi-arrow-right"></i>
                </div>
            </div>
        `;
    }

    async function loadHistory() {
        const container = document.getElementById('meetingsContainer');
        container.innerHTML = '<div class="loading-state"><div class="loading-spinner mb-3"></div><p class="text-muted">ƒêang t·∫£i...</p></div>';

        try {
            // Get filter and sort params
            const filterType = document.getElementById('filterType').value;
            const sortBy = document.getElementById('filterSort').value;

            // Call backend API with params - ALL LOGIC IN BACKEND!
            const response = await fetch(`/api/history/list?filter_type=${filterType}&sort_by=${sortBy}&limit=500`);
            const data = await response.json();

            if (data.history && data.history.length > 0) {
                // Store all meetings for pagination
                allMeetings = data.history;
                currentPage = 1;

                // Render first page
                displayMeetingsForPage();
                renderPagination();
            } else {
                allMeetings = [];
                showEmptyState();
            }
        } catch (error) {
            console.error('Error loading history:', error);
            container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="bi bi-exclamation-triangle"></i></div><h4>L·ªói t·∫£i d·ªØ li·ªáu</h4><p class="text-muted">Vui l√≤ng th·ª≠ l·∫°i sau</p></div>';
        }
    }

    // NO FILTER LOGIC HERE - just reload with new params
    function filterMeetings() {
        currentPage = 1;
        loadHistory(); // Backend does all filtering and sorting!
    }



    function createMeetingCard(meeting) {
        const date = meeting.timestamp ? new Date(meeting.timestamp).toLocaleString('vi-VN') : 'N/A';
        const duration = meeting.metadata?.duration || meeting.duration || '0:00';

        // Extract title: priority order - title > original_file > summary
        let title = meeting.title;
        if (!title && meeting.original_file) {
            title = meeting.original_file
                .replace(/\.mp3$/i, '')
                .replace(/_/g, ' ')
                .split('.')[0]; // Get first part before extension
            // Capitalize
            title = title.charAt(0).toUpperCase() + title.slice(1);
        }
        if (!title) {
            title = meeting.summary ? meeting.summary.substring(0, 60) + '...' : 'Cu·ªôc h·ªçp';
        }

        const language = meeting.metadata?.language || meeting.language || 'vi';

        const languageFlags = {
            'vi': 'üáªüá≥',
            'en': 'üá¨üáß',
            'ja': 'üáØüáµ',
            'ko': 'üá∞üá∑',
            'zh': 'üá®üá≥'
        };

        return `
            <div class="meeting-card" data-meeting-id="${meeting.id}">
                <div class="meeting-icon-wrapper">
                    <div class="meeting-icon">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                </div>
                <div class="meeting-content">
                    <div class="meeting-title">${title}</div>
                    <div class="meeting-meta">
                        <div class="meeting-meta-item">
                            <i class="bi bi-calendar3"></i>
                            <span>${date}</span>
                        </div>
                        <div class="meeting-meta-item">
                            <i class="bi bi-clock"></i>
                            <span>${duration}</span>
                        </div>
                        <div class="meeting-meta-item">
                            <span>${languageFlags[language] || 'üåê'}</span>
                            <span>${language.toUpperCase()}</span>
                        </div>
                    </div>
                </div>
                <div class="meeting-arrow">
                    <i class="bi bi-arrow-right"></i>
                </div>
            </div>
        `;
    }

    function showEmptyState() {
        const container = document.getElementById('meetingsContainer');
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="bi bi-inbox"></i>
                </div>
                <h4>Ch∆∞a c√≥ cu·ªôc h·ªçp n√†o</h4>
                <p class="text-muted mb-4">B·∫Øt ƒë·∫ßu ghi √¢m ho·∫∑c upload file ƒë·ªÉ t·∫°o cu·ªôc h·ªçp ƒë·∫ßu ti√™n</p>
                <a href="/" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>T·∫°o cu·ªôc h·ªçp m·ªõi
                </a>
            </div>
        `;
    }

    // ===== PAGINATION LOGIC =====
    let currentPage = 1;
    const itemsPerPage = 10;
    let allMeetings = [];

    function renderPagination() {
        const totalPages = Math.ceil(allMeetings.length / itemsPerPage);
        const container = document.getElementById('paginationContainer');
        const list = document.getElementById('paginationList');
        const info = document.getElementById('paginationInfo');

        if (totalPages <= 1) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';

        // Build pagination HTML dynamically
        let html = '';

        // Previous button
        html += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
        `;

        // Page numbers with smart ellipsis
        const maxVisible = 7; // Show max 7 page numbers
        let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let endPage = Math.min(totalPages, startPage + maxVisible - 1);

        if (endPage - startPage < maxVisible - 1) {
            startPage = Math.max(1, endPage - maxVisible + 1);
        }

        // First page + ellipsis
        if (startPage > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1); return false;">1</a></li>`;
            if (startPage > 2) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        // Visible page numbers
        for (let i = startPage; i <= endPage; i++) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                </li>
            `;
        }

        // Ellipsis + last page
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a></li>`;
        }

        // Next button
        html += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        `;

        list.innerHTML = html;

        // Update info text
        const start = (currentPage - 1) * itemsPerPage + 1;
        const end = Math.min(currentPage * itemsPerPage, allMeetings.length);
        info.textContent = `Hi·ªÉn th·ªã ${start}-${end} trong ${allMeetings.length} cu·ªôc h·ªçp`;
    }

    function changePage(page) {
        const totalPages = Math.ceil(allMeetings.length / itemsPerPage);
        if (page < 1 || page > totalPages) return;

        currentPage = page;
        displayMeetingsForPage();
        renderPagination();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function displayMeetingsForPage() {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = allMeetings.slice(start, end);

        const container = document.getElementById('meetingsContainer');
        const gridHtml = pageItems.map(meeting => createMeetingCard(meeting)).join('');

        container.innerHTML = `<div class="meetings-grid">${gridHtml}</div>`;

        // Add click listeners
        document.querySelectorAll('.meeting-card').forEach(card => {
            card.addEventListener('click', () => {
                const meetingId = card.dataset.meetingId;
                window.location.href = `/meeting/${encodeURIComponent(meetingId)}`;
            });
        });
    }

    // Override filterMeetings to work with pagination
    const originalFilterMeetings = filterMeetings;
    filterMeetings = function () {
        currentPage = 1;
        originalFilterMeetings();
        renderPagination();
    };

    // ===== FLOATING CHATBOX LOGIC =====
    function toggleChatbox() {
        const chatbox = document.getElementById('floatingChatbox');
        chatbox.classList.toggle('minimized');
    }

    function clearChatHistory() {
        const messagesDiv = document.getElementById('chatboxMessages');
        messagesDiv.innerHTML = `
            <div class="chat-message ai-message">
                <div class="message-avatar"><i class="bi bi-stars"></i></div>
                <div class="message-content">
                    Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m hi·ªÉu v·ªÅ c√°c cu·ªôc h·ªçp. H√£y th·ª≠:
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>"T√¨m workshop v·ªÅ design"</li>
                        <li>"Ai ƒë∆∞·ª£c ph·ªèng v·∫•n tu·∫ßn n√†y?"</li>
                        <li>"Quy·∫øt ƒë·ªãnh quan tr·ªçng l√† g√¨?"</li>
                    </ul>
                </div>
            </div>
        `;
    }

    function handleChatboxEnter(e) {
        if (e.key === 'Enter') {
            sendChatboxMessage();
        }
    }

    async function sendChatboxMessage() {
        const input = document.getElementById('chatboxInput');
        const message = input.value.trim();

        if (!message) return;

        // Clear input
        input.value = '';

        // Append user message
        appendChatboxMessage('user', message);

        // Show typing indicator
        appendChatboxMessage('ai', '<div class="typing-indicator">ƒêang suy nghƒ©...</div>');

        try {
            const response = await fetch('/api/history/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();

            // Remove typing indicator
            const messagesDiv = document.getElementById('chatboxMessages');
            messagesDiv.lastElementChild.remove();

            if (data.error) {
                appendChatboxMessage('ai', `‚ö†Ô∏è ${data.error}`);
            } else {
                let answerHtml = data.answer.replace(/\n/g, '<br>');

                // Add sources
                if (data.sources && data.sources.length > 0) {
                    answerHtml += `<div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb; font-size: 0.875rem;">`;
                    answerHtml += `<strong>üìö Ngu·ªìn:</strong><br>`;
                    data.sources.slice(0, 3).forEach(src => {
                        answerHtml += `<span style="color: #6366f1; cursor: pointer;" onclick="highlightMeeting('${src.name}')">[${src.id}] ${src.name}</span><br>`;
                    });
                    answerHtml += `</div>`;
                }

                appendChatboxMessage('ai', answerHtml);
            }
        } catch (error) {
            const messagesDiv = document.getElementById('chatboxMessages');
            messagesDiv.lastElementChild.remove();
            appendChatboxMessage('ai', '‚ö†Ô∏è L·ªói k·∫øt n·ªëi server.');
        }
    }

    function appendChatboxMessage(role, htmlContent) {
        const messagesDiv = document.getElementById('chatboxMessages');
        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message ${role}-message`;

        const avatar = role === 'user' ?
            '<i class="bi bi-person-circle"></i>' :
            '<i class="bi bi-stars"></i>';

        msgDiv.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">${htmlContent}</div>
        `;

        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function highlightMeeting(filename) {
        // Scroll to meeting and highlight
        const cards = document.querySelectorAll('.meeting-card');
        cards.forEach(card => {
            if (card.textContent.includes(filename)) {
                card.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    card.style.background = '';
                }, 2000);
            }
        });
    }
</script>
{% endblock %}